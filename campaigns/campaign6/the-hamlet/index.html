<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Hamlet</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&display=swap');
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'UnifrakturCook', cursive;
      color: #ff4444;
      background: url('https://cdnb.artstation.com/p/assets/images/images/057/688/955/large/sfc-.jpg?1672363017') no-repeat center center fixed;
      background-size: cover;
      overflow-x: hidden;
      font-size: 1.5rem;
      animation: fadeInBody 2s ease-in-out;
    }

    @keyframes fadeInBody {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 1rem;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 11;
    }

    .back-button {
      background-color: rgba(0, 0, 0, 0.6);
      color: #ff4444;
      border: none;
      padding: 0.4rem 1rem;
      font-size: 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background-color: #ff4444;
      color: black;
    }

    .info-box {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 1rem;
      max-width: 420px;
      border-radius: 10px;
      font-family: 'Cormorant Garamond', serif;
      color: #ffdddd;
      font-size: 1.2rem;
      line-height: 1.5;
      z-index: 10;
      overflow-y: auto;
      max-height: 70vh;
      box-shadow: 0 0 10px #ff4444;
    }

    .info-box b {
      color: #ff8888;
    }

    h1, h2 {
      text-align: center;
      text-shadow: 0 0 12px #000;
    }

    h1 {
      font-size: 6rem;
      margin-top: 5rem;
      animation: flicker 3s infinite alternate;
    }

    h2 {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    @keyframes flicker {
      0% { opacity: 1; text-shadow: 0 0 10px #ff4444; }
      100% { opacity: 0.85; text-shadow: 0 0 25px #ff8888; }
    }

    h3 {
      font-size: 2.5rem;
      font-weight: bold;
    }

    h4 {
      font-size: 2rem;
      font-weight: bold;
    }

    li {
      font-size: 1.8rem;
    }

    .section {
      padding: 2rem;
    }

    .token-area {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 4rem;
      min-height: 120px;
    }

    .token {
      width: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: grab;
      position: relative;
      transition: transform 0.3s ease, filter 0.3s ease;
      padding-bottom: 40px;
    }

    .token:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 10px #ff4444);
    }

    .token img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 3px solid white;
      object-fit: cover;
    }

    .token-label {
      margin-top: 0.3rem;
      font-size: 1.5rem;
      font-weight: bold;
      color: #ff4444;
      text-shadow: 1px 1px 2px black;
    }

    .tag-panel {
      display: flex;
      justify-content: center;
      gap: 10px;
      background-color: rgba(26, 26, 26, 0.8);
      padding: 15px;
      border-radius: 15px;
      margin: 0 auto;
      max-width: fit-content;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .tag {
      padding: 5px 10px;
      border-radius: 5px;
      cursor: grab;
      user-select: none;
      font-size: 14px;
      font-weight: bold;
    }

    .tag[data-tag="Wounded"] { background-color: #8B0000; color: white; }
    .tag[data-tag="Severely Wounded"] { background-color: #5A0000; color: white; }
    .tag[data-tag="Madness"] { background-color: #999900; color: black; }
    .tag[data-tag="Dead"] { background-color: #e0e0e0; color: black; }
    .tag[data-tag="Morale"] {
      background-color: #006600;
      color: white;
    }

    .token-tags {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      width: 100%;
    }

    .token-tag {
      font-size: 12px;
      padding: 2px 5px;
      border-radius: 3px;
      cursor: pointer;
      white-space: nowrap;
    }

    .token-tag[data-tag="Wounded"] { background-color: #8B0000; color: white; }
    .token-tag[data-tag="Severely Wounded"] { background-color: #5A0000; color: white; }
    .token-tag[data-tag="Madness"] { background-color: #999900; color: black; }
    .token-tag[data-tag="Dead"] { background-color: #e0e0e0; color: black; }
    .token-tag[data-tag="Morale"] { 
      background-color: #006600; 
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      padding: 5px;
      width: 100%;
    }

    .morale-bar {
      width: 80px;
      height: 10px;
      background-color: #333;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }

    .morale-fill {
      height: 100%;
      background-color: #4CAF50;
      width: 50%;
      transition: width 0.3s ease;
    }

    .morale-value {
      font-size: 10px;
      color: white;
    }

    h2 {
      text-align: center;
      margin: 20px;
    }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      animation: fadeInModal 0.4s ease;
      padding: 1rem;
    }

    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: #111;
      padding: 2rem;
      border-radius: 20px;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 2rem;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      font-family: 'Cormorant Garamond', serif;
      box-shadow: 0 0 15px #ff4444;
      font-size: 1.8rem;
      color: #ffdddd;
    }

    .modal-content img {
      max-width: 100%;
      width: 600px;
      height: auto;
      border-radius: 12px;
      border: 3px solid #ff4444;
      flex-shrink: 0;
    }

    .modal-content > div {
      flex: 1;
      min-width: 280px;
    }

    .modal-close {
      position: fixed;
      top: 1rem;
      right: 1rem;
      font-size: 3rem;
      color: white;
      cursor: pointer;
      z-index: 11;
    }

    .operation-area {
      padding: 2rem;
      background-color: rgba(0,0,0,0.6);
      border-radius: 20px;
      max-width: 900px;
      margin: 0 auto;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
    }

    .operation-grid {
      display: grid;
      grid-template-columns: repeat(4, 100px);
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }

    .slot {
      width: 100px;
      height: 100px;
      border: 2px dashed white;
      border-radius: 10px;
      background-color: rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    .slot:hover {
      border-color: #ff4444;
      background-color: rgba(255, 0, 0, 0.2);
      box-shadow: 0 0 10px #ff4444;
    }

    .disabled-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 9;
      display: none;
    }

    #volume-control-wrapper {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 0.3rem 0.7rem;
      border-radius: 8px;
      z-index: 10;
      width: 160px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    #volume-control { width: 100%; }

    #volume-control-label {
      font-size: 1.2rem;
      color: #ff4444;
      margin-bottom: 0.2rem;
      text-align: center;
    }

    /* Morale Input Modal */
    .morale-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }

    .morale-modal-content {
      background-color: #222;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
      box-shadow: 0 0 15px rgba(0, 100, 0, 0.5);
      font-family: 'Cormorant Garamond', serif;
    }

    .morale-modal h3 {
      margin-top: 0;
      color: #4CAF50;
    }

    .morale-input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      box-sizing: border-box;
      border: 2px solid #4CAF50;
      border-radius: 4px;
      background-color: #111;
      color: white;
      text-align: center;
      font-size: 16px;
    }

    .validate-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .validate-btn:hover {
      background-color: #45a049;
    }

    @media (max-width: 768px) {
      .modal-content {
        flex-direction: column;
        align-items: center;
      }

      .modal-content img {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <header id="header">
    <a href="../index.html" class="back-button" id="back-button">← Geri Dön</a>
  </header>

  <audio id="background-music" autoplay loop preload="auto">
    <source src="Darkest Dungeon II OST - The Inn (2023) HQ Official.mp3" type="audio/mp3" />
  </audio>

  <div id="volume-control-wrapper">
    <label id="volume-control-label">Müzik Sesi: <span id="volume-level">50%</span></label>
    <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.5"/>
  </div>

  <div class="info-box">
    <b>Campaign 6 - The Dark Path Terimleri:</b><br/>
    • <b>Success Rate:</b> Bir Operasyonun başarı şansıdır. Çeşitli değişkenlere göre artıp azalabilir. Success Rate en az %10 ve en fazla %90 olabilir.<br/>
    • <b>Morale:</b> Operasyon öncesi ve sonrasında kişinin moralini ve ne kadar operasyona hazır olduğunu belirtir. Bu değer 0 ile 100 arasında değişir. Bir kişinin bir Operasyona katılabilmesi için en az 40 morale ihtiyacı vardır. Baz olarak (çarpanlar eklenmemişken) başarılı bir Operasyonda 20, başarısız bir Operasyonda ise 40 moral azalır.<br/>
    • <b>Wounded:</b> Bir kişinin yaralandığını gösterir. Bu yara hem mental hem fiziksel hem de metafiziksel olabilir. Yaralı bir kişi, iyileşene kadar yeni bir Operasyona gönderilemez. Yaralı birinin yarası bir hafta içerisinde iyileşir.<br/>
    • <b>Severely Wounded:</b> Bir kişinin ağır bir biçimde yaralandığını gösterir. Bu ağır yara hem mental hem fiziksel hem de metafiziksel olabilir. Ağır Yaralı bir kişi, iyileşene kadar yeni bir Operasyona gönderilemez. Ağır Yaralı birinin yarası üç hafta içerisinde iyileşir.<br/>
    • <b>Madness:</b> Bir kişinin halihazırda bir Madness etkisinde olduğunu gösterir. Madness'ı olan kişilerin Operasyon sırasında sorun çıkarmaları daha olasıdır.<br/>
    • <b>Dead:</b> Bir kişinin öldüğünü gösterir. Ölmüş kişiler Operasyonlara gönderilemezler! Ölmüş kişiyi hayata geri getirmek için çeşitli ritüeller ve masraflar gerekir.
  </div>

  <h1>The Hamlet</h1>

  <div class="tag-panel">
    <div class="tag" draggable="true" data-tag="Wounded">Wounded</div>
    <div class="tag" draggable="true" data-tag="Severely Wounded">Severely Wounded</div>
    <div class="tag" draggable="true" data-tag="Madness">Madness</div>
    <div class="tag" draggable="true" data-tag="Dead">Dead</div>
    <div class="tag" draggable="true" data-tag="Morale">Morale</div>
  </div>

  <div class="section">
    <h2>On-Rest</h2>
    <div class="token-area" id="rest-area">
      <div class="token" draggable="true"
        data-name="Lurien Veil"
        data-img="the-hamlet-tokenler-resimler/Lurien Veil.jpg"
        data-quirks='{"positive":[{"name":"<b><i><u>Trauma Immunity</u></i></b>","desc":"Bu karakter tramvatik olaylardan olumsuz etkilenmez, etkilense bile dışarıya yansıtmaz."},{"name":"<b><i><u>Perfect Soldier</u></i></b>","desc":"Bu karakter verilen emirlere uyarken ahlaki moral dilemmaları yaşamaz."}],"negative":[{"name":"<b><i><u>Heteronomy</u></i></b>","desc":"Bu karakterin iradesi çok zayıftır, dış güçler ve idealler tarafından kolayca manipüle edilebilir."},{"name":"<b><i><u>Unpredictable</u></i></b>","desc":"Bu karakterin akıl sağlığı yerinde olmadığı için ne yapacağı öngörülemez."}]}'
        data-affiliations='["Otherworldly","Mage","Underdark","Freak","Unstable"]'>
        <img src="the-hamlet-tokenler-resimler/Lurien Veil Token.png" alt="Lurien">
        <div class="token-label">Lurien</div>
        <div class="token-tags"></div>
      </div>

      <div class="token" draggable="true"
        data-name="Erevan Duskwight"
        data-img="the-hamlet-tokenler-resimler/Erevan Duskwight.jpg"
        data-quirks='{"positive":[{"name":"<b><i><u>Strategist</u></i></b>","desc":"Bu karakter plan kurgulamakta iyidir."},{"name":"<b><i><u>Connections</u></i></b>","desc":"Bu karakterin bağlantıları ve bağlantılı olduğu kişiler güçlüdür."}],"negative":[{"name":"<b><i><u>Egoistical</u></i></b>","desc":"Bu karakter karar alınırken bencilce davranabilir."},{"name":"<b><i><u>Hubris Syndrome</u></i></b>","desc":"Bu karakter bir Narsist ve kendini sayılı kişiler hariç birçok kişiden üstün görür."}]}'
        data-affiliations='["Boss","Mage","Underdark","Goliath","Immortal Nature"]'>
        <img src="the-hamlet-tokenler-resimler/Erevan Duskwight Token.png" alt="Erevan">
        <div class="token-label">Erevan</div>
        <div class="token-tags"></div>
      </div>
    </div>
  </div>

  <div class="section operation-area">
    <h2>Operation Teams</h2>
    <div class="operation-grid" id="team-row-1">
      <div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div>
    </div>
    <div style="height:1.5rem;"></div>
    <div class="operation-grid" id="team-row-2">
      <div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div>
    </div>
  </div>

  <div class="modal" id="modal">
    <span class="modal-close" id="close-modal">&times;</span>
    <div class="modal-content">
      <img id="modal-image" src="" alt="Character">
      <div>
        <h3 id="modal-name"></h3>
        <h4>Positive Quirks</h4>
        <ul id="modal-positive"></ul>
        <h4>Negative Quirks</h4>
        <ul id="modal-negative"></ul>
        <h4>Affiliations</h4>
        <ul id="modal-affiliations"></ul>
      </div>
    </div>
  </div>

  <!-- Morale Input Modal -->
  <div class="morale-modal" id="morale-modal">
    <div class="morale-modal-content">
      <h3>Kişinin Moralini Giriniz</h3>
      <p>Lütfen 0 ile 100 arasında bir değer girin:</p>
      <input type="number" class="morale-input" id="morale-input" min="0" max="100" value="50">
      <button class="validate-btn" id="validate-btn">Doğrula</button>
    </div>
  </div>

  <div class="disabled-overlay" id="disabled-overlay"></div>

  <audio id="drop-sound">
    <source src="Token Sound Effect.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const modal = document.getElementById("modal");
    const closeModal = document.getElementById("close-modal");
    const disabledOverlay = document.getElementById("disabled-overlay");
    const backButton = document.getElementById("back-button");
    const moraleModal = document.getElementById("morale-modal");
    const moraleInput = document.getElementById("morale-input");
    const validateBtn = document.getElementById("validate-btn");
    let draggedToken = null;
    let currentTokenForMorale = null;

    // Token tıklama ve modal açma
    document.querySelectorAll('.token').forEach(token => {
      token.addEventListener("click", function(e) {
        // Eğer tıklanan element bir token-tag ise işlemi durdur
        if (e.target.classList.contains('token-tag') || 
            e.target.classList.contains('morale-bar') || 
            e.target.classList.contains('morale-fill') || 
            e.target.classList.contains('morale-value')) {
          return;
        }
        
        try {
          const img = this.dataset.img;
          const name = this.dataset.name;
          
          // JSON.parse hatalarını yakalamak için try-catch blokları
          let quirks, affiliations;
          try {
            quirks = JSON.parse(this.dataset.quirks);
          } catch (e) {
            console.error("Quirks verisi parse edilemedi:", this.dataset.quirks);
            quirks = {positive: [], negative: []};
          }
          
          try {
            affiliations = JSON.parse(this.dataset.affiliations);
          } catch (e) {
            console.error("Affiliations verisi parse edilemedi:", this.dataset.affiliations);
            affiliations = [];
          }

          document.getElementById("modal-image").src = img;
          document.getElementById("modal-name").textContent = name;

          const formatQuirks = (list) => {
            return list.map(q => `<li><span class="quirk-name">${q.name}</span>: ${q.desc}</li>`).join("");
          };

          document.getElementById("modal-positive").innerHTML = quirks.positive ? formatQuirks(quirks.positive) : "";
          document.getElementById("modal-negative").innerHTML = quirks.negative ? formatQuirks(quirks.negative) : "";
          document.getElementById("modal-affiliations").innerHTML = affiliations ? affiliations.map(a => `<li>${a}</li>`).join("") : "";

          modal.style.display = "flex";
          disabledOverlay.style.display = "block";
          document.getElementById("volume-control-wrapper").style.display = "none";
          backButton.style.display = "none";
        } catch (error) {
          console.error("Token bilgileri yüklenirken hata oluştu:", error);
          alert("Karakter bilgileri yüklenirken bir hata oluştu. Lütfen konsolu kontrol edin.");
        }
      });

      token.addEventListener("dragstart", function(e) {
        draggedToken = this;
        e.dataTransfer.setData("text/plain", null);
        document.getElementById("drop-sound").play();
      });
    });

    // Slot drag-drop işlemleri
    document.querySelectorAll(".slot").forEach(slot => {
      slot.addEventListener("dragover", e => e.preventDefault());
      slot.addEventListener("drop", e => {
        e.preventDefault();
        if (draggedToken && !slot.querySelector(".token")) {
          slot.appendChild(draggedToken);
          document.getElementById("drop-sound").play();
          draggedToken = null;
        }
      });
    });

    // Rest alanı drag-drop işlemleri
    const restArea = document.getElementById("rest-area");
    restArea.addEventListener("dragover", e => e.preventDefault());
    restArea.addEventListener("drop", e => {
      e.preventDefault();
      if (draggedToken) {
        restArea.appendChild(draggedToken);
        draggedToken = null;
      }
    });

    // Modal kapatma
    closeModal.addEventListener("click", () => {
      modal.style.display = "none";
      disabledOverlay.style.display = "none";
      document.getElementById("volume-control-wrapper").style.display = "flex";
      backButton.style.display = "inline-block";
    });

    // Ses kontrolü
    document.getElementById("volume-control").addEventListener("input", function () {
      const volume = parseFloat(this.value);
      document.getElementById("background-music").volume = volume;
      document.getElementById("volume-level").textContent = `${Math.round(volume * 100)}%`;
    });

    // Tag drag-drop işlemleri
    let draggedTag = null;

    document.querySelectorAll('.tag').forEach(tag => {
      tag.addEventListener('dragstart', (e) => {
        draggedTag = e.target.cloneNode(true);
        e.dataTransfer.setData("text/plain", draggedTag.dataset.tag);
      });
    });

    // Token'lere tag ekleme
    document.querySelectorAll('.token').forEach(token => {
      token.addEventListener('dragover', (e) => e.preventDefault());

      token.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!draggedTag) return;
        
        const tagType = draggedTag.dataset.tag;
        const tagsContainer = token.querySelector('.token-tags');
        
        const existingTag = [...tagsContainer.children].find(t => t.dataset.tag === tagType);
        if (existingTag) return;

        if (tagType === 'Morale') {
          currentTokenForMorale = token;
          moraleInput.value = '50';
          moraleModal.style.display = 'flex';
          disabledOverlay.style.display = 'block';
        } else {
          const newTag = document.createElement('div');
          newTag.classList.add('token-tag');
          newTag.dataset.tag = tagType;
          newTag.textContent = tagType;

          newTag.addEventListener('click', (e) => {
            e.stopPropagation();
            newTag.remove();
          });

          tagsContainer.appendChild(newTag);
        }
        
        draggedTag = null;
      });
    });

    // Morale değerini doğrulama
    validateBtn.addEventListener('click', () => {
      const value = parseInt(moraleInput.value);
      
      if (isNaN(value) || value < 0 || value > 100) {
        alert('Lütfen 0 ile 100 arasında bir değer girin!');
        return;
      }

      if (currentTokenForMorale) {
        const tagsContainer = currentTokenForMorale.querySelector('.token-tags');
        const existingTag = [...tagsContainer.children].find(t => t.dataset.tag === 'Morale');
        
        if (existingTag) {
          // Varolan morale tag'ını güncelle
          existingTag.querySelector('.morale-fill').style.width = `${value}%`;
          existingTag.querySelector('.morale-value').textContent = `${value}/100`;
        } else {
          // Yeni morale tag'ı oluştur
          const newTag = document.createElement('div');
          newTag.classList.add('token-tag');
          newTag.dataset.tag = 'Morale';
          
          newTag.innerHTML = `
            <div class="morale-bar">
              <div class="morale-fill" style="width: ${value}%"></div>
            </div>
            <div class="morale-value">${value}/100</div>
          `;

          newTag.addEventListener('click', (e) => {
            if (e.target === newTag || e.target.classList.contains('morale-bar') || e.target.classList.contains('morale-fill')) {
              e.stopPropagation();
              currentTokenForMorale = newTag.closest('.token');
              moraleInput.value = value;
              moraleModal.style.display = 'flex';
              disabledOverlay.style.display = 'block';
            }
          });

          tagsContainer.appendChild(newTag);
        }
      }

      moraleModal.style.display = 'none';
      disabledOverlay.style.display = 'none';
      currentTokenForMorale = null;
    });

    // Sayfa yüklendiğinde müzik sesini ayarla
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("background-music").volume = 0.5;
    });
  </script>
</body>
</html>
